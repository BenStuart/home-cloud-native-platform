---

- name: "Remove container {{ consul.container.name }}-{{ ansible_hostname }} and associated volumes"
  docker_container:
    name: "{{ consul.container.name }}-{{ ansible_hostname }}"
    keep_volumes: no
    state: absent

- name: Consul configuration volume
  docker_volume:
    name: "{{ consul.volumes.configuration }}"
    force: yes

- name: Consul data volume
  docker_volume:
    name: "{{ consul.volumes.data }}"
    force: yes

- name: "Run {{ consul.image.name }}:{{ consul.image.tag }} as container {{ consul.container.name }}-{{ ansible_hostname }} as server"
  docker_container:
    name: "{{ consul.container.name }}-{{ ansible_hostname }}"
    image: "{{ consul.image.name }}:{{ consul.image.tag }}"
    command:
      - agent
      - -bind="{{ consul.bind }}"
      - -bootstrap-expect=1
      - -client=0.0.0.0
      - -datacenter="{{ consul.datacenter }}"
      - -dns-port="{{ consul.container.ports.dns }}"
      - -recursor="{{ consul.dns_recursor }}"
      - -server
      - -ui
      - -config-dir=/consul/config
      - -data-dir=/consul/data
    detach: true
    env:
      CONSUL_ALLOW_PRIVILEGED_PORTS:
      CONSUL_BIND_INTERFACE: "{{ consul.interfaces.bind }}"
      CONSUL_CLIENT_INTERFACE: "{{ consul.interfaces.client }}"
    hostname: "consul-{{ ansible_hostname }}"
    network_mode: "{{ consul.network_mode }}"
    published_ports:
     - 8300:8300
     - 8301:8301
     - 8301:8301/udp
     - 8302:8302
     - 8302:8302/udp
     - 8400:8400
     - 8500:8500
     - 8600:8600
     - "{{ ansible_host }}:{{consul.container.ports.dns}}:8600/udp"
    state: started
    recreate: yes
    restart_policy: "{{ consul.container.restart.policy }}"
    volumes:
      - "{{ consul.volumes.configuration }}:/consul/config"
      - "{{ consul.volumes.data }}:/consul/data"
    # command: -server -advertise "{{consul_advertise}}" -bootstrap-expect "{{consul_bootstrap_expect}}" -ui-dir /ui
  register: consul_container_launched
  when: consul_mode == "server"

- name: "Run {{ consul.image.name }}:{{ consul.image.tag }} as container {{ consul.container.name }}-{{ ansible_hostname }} as node"
  docker_container:
    name: "{{ consul.container.name }}-{{ ansible_hostname }}"
    image: "{{ consul.image.name }}:{{ consul.image.tag }}"
    command:
      - agent
      - -bind="{{ consul.bind }}"
      - -client=0.0.0.0
      - -datacenter="{{ consul.datacenter }}"
      - -dns-port="{{ consul.container.ports.dns }}"
      - -recursor="{{ consul.dns_recursor }}"
      - -retry-join="{{ controller_name }}"
      - -config-dir=/consul/config
      - -data-dir=/consul/data
    detach: true
    env:
      CONSUL_ALLOW_PRIVILEGED_PORTS:
      CONSUL_BIND_INTERFACE: "{{ consul.interfaces.client }}"
      CONSUL_CLIENT_INTERFACE: "{{ consul.interfaces.client }}"
    hostname: "consul-{{ ansible_hostname }}"
    network_mode: host
    published_ports:
     - 8300:8300
     - 8301:8301
     - 8301:8301/udp
     - 8302:8302
     - 8302:8302/udp
     - 8400:8400
     - 8500:8500
     - 8600:8600
     - "{{ ansible_host }}:{{consul.container.ports.dns}}:8600/udp"
    state: started
    recreate: yes
    restart_policy: "{{ consul.container.restart.policy }}"
    volumes:
      - "{{ consul.volumes.config }}:/consul/config"
      - "{{ consul.volumes.data }}:/consul/data"
    # command: -server -advertise "{{consul_advertise}}" -bootstrap-expect "{{consul_bootstrap_expect}}" -ui-dir /ui
  register: consul_container_launched
  when: (consul_mode is not defined or consul_mode != "server")

- name: Wait for consul to launch
  wait_for:
    port: "{{ consul.container.ports.http }}"
    delay: 5
  when: consul_container_launched

- name: "Register {{ ansible_host }} with Consul DNS"
  uri:
    url: "http://{{ consul_server }}:{{ consul.container.ports.http }}/v1/catalog/register"
    method: PUT
    body: '{"Datacenter": "{{ consul.datacenter }}", "Node": "hcnp-hosts", "Address": "{{ ansible_default_ipv4.interface }}", "Service": {"ID": "{{ ansible_host }}", "Service": "{{ ansible_host }}", "Address": "{{ ansible_default_ipv4.interface }}", "Port": 80}}'
    body_format: json
    headers:
      Content-Type: "application/json"
    status_code: 200, 201, 204
  when: consul_container_launched
