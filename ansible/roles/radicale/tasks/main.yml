---

# - name: Get source
#   git:
#     repo: "{{ radicale.project.src }}"
#     dest: "/tmp/radicale"
#     update: yes

- name: Build image
  docker_image:
    # path: /tmp/radicale
    path: ~/radicale
    name: "{{ radicale.container.image }}:{{ radicale.container.tag}}"
    tag: latest

- name: Create directory for radicale configuration
  file:
    path: /etc/radicale
    group: "{{ ansible_user_id }}"
    # mode:
    owner: "{{ ansible_user_id }}"
    state: directory

- name: Copy configuration file
  copy:
    dest: /etc/radicale/config
    src: config
    group: "{{ ansible_user_id }}"
    # mode: undefined # not required. Mode the file or directory should be. For those used to I(/usr/bin/chmod) remember that modes are actually octal numbers. You must either add a leading zero so that Ansible's YAML parser knows it is an octal number (like C(0644) or C(01777)) or quote it (like C('644') or C('1777')) so Ansible receives a string and can do its own conversion from string into number.  Giving Ansible a number without following one of these rules will end up with a decimal number which will have unexpected results.  As of version 1.8, the mode may be specified as a symbolic mode (for example, C(u+rwx) or C(u=rw,g=r,o=r)).  As of version 2.3, the mode may also be the special string C(preserve).  C(preserve) means that the file will be given the same permissions as the source file.
    owner: "{{ ansible_user_id }}"
    backup: yes # not required. Create a backup file including the timestamp information so you can get the original file back if you somehow clobbered it incorrectly.

# docker run --name=gogs -p 10022:22 -p 10080:3000 -v /var/gogs:/data gogs/gogs-rpi
- name: "Run image {{ radicale.container.image }}:{{ radicale.container.tag}} as container {{ radicale.container.name }}"
  docker_container:
    name: "{{ radicale.container.name }}"
    image: "{{ radicale.container.image }}:{{ radicale.container.tag}}"
    recreate: yes
    state: started
    # command: ["radicale", "--hosts", "0.0.0.0:5232"]
    volumes:
    - "/etc/radicale/config:/etc/radicale/config"
    - "/var/lib/radicale:/var/lib/radicale"

